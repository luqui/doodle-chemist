<html>
<head>
<link rel="stylesheet" type="text/css" href="pixedit.css" />
<script src="utils.js"></script>
<script src="reactor.js"></script>
<script src="laboratory.js"></script>
<script src="pixedit.js"></script>
<script src="site/jquery-3.3.1.js"></script>
<script src="site/gif.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.13.0/firebase.js"></script>
<!-- <script src="https://www.gstatic.com/firebasejs/4.13.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.13.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.13.0/firebase-database.js"></script>
-->
<script src="https://www.gstatic.com/firebasejs/4.13.0/firebase-firestore.js"></script>
<!--
<script src="https://www.gstatic.com/firebasejs/4.13.0/firebase-messaging.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.13.0/firebase-functions.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.13.0/firebase-storage.js"></script>
-->
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyBjpYowQZ1sewFmHEJl9ZDfDx20rsQ_tZQ",
    authDomain: "doodle-chemist.firebaseapp.com",
    databaseURL: "https://doodle-chemist.firebaseio.com",
    projectId: "doodle-chemist",
    storageBucket: "doodle-chemist.appspot.com",
    messagingSenderId: "1086839312639"
  };
  firebase.initializeApp(config);

  // "element1:element2" : {  // element1 <= element2
  //   demand: <nat>
  //   results: {
  //     element3: <nat>
  //     element4: <nat>
  //     ...
  //   }
  var firestore = firebase.firestore();
  firestore.settings({timestampsInSnapshots: true});

  var storage = firebase.storage();

  $(function() {
    var refreshReactor = function() {
      $('#editor').empty();
      reactor.refresh();
    };

    var getImage = function(element) {
      return new Promise(function(cb) {
        firestore.collection("elements").doc(element).get()
          .then(function(doc) {
            if (doc.exists) {
              var data = doc.data();
              var imgname = data.imgname;
              var ref = storage.ref('elements').child(element).child(imgname);
              ref.getDownloadURL().then(function(url) {
                cb({
                  url: url,
                  ordinal: data.ordinal
                });
              });
            }
            else {
              cb(null);
            }
          });
      });
    };
    
    var utils = Utils({getImage: getImage}); // XXX Bad design


    var putImage = function(element, blob, ordinal) {
      var id = Math.floor(1e6*Math.random());
      var imgname = ordinal + "_" + id + ".gif";
      var ref = storage.ref('elements').child(element).child(imgname);
      return ref.put(blob, { contentType: 'image/gif' }).then(function() { 
        var docref = firestore.collection("elements").doc(element);
        docref.set({ imgname: imgname, ordinal: ordinal });
      });
    };

    var reactor = Reactor({
      container: $('#reactor')[0],
      database: firestore,
      onMatch: function(element) {
        getImage(element).then(function(img) {
          var editor = PixEditor({
            container: $('#editor')[0],
            width: 32,
            height: 32,
            scale: 20,
            modlimit: 32*32,
            base: img ? img.url : null,
            callback: function() {
              editor.toGif().then(function(blob) {
                return putImage(element, blob, img ? img.ordinal+1 : 0);
              }).then(function() {
                refreshReactor();
              });
            },
            title: element
          });
        });
      },
      onNoMatch: function() {
        $('#editor').text("No match");
        utils.delay(2000).then(refreshReactor);
      },
      utils: utils
    });

    var laboratory = Laboratory({
      container: $('#laboratory')[0],
      database: firestore,
      utils: utils
    });
    
    reactor.refresh();
    laboratory.refresh();
  });

</script>
</head>
<body>
<div id="reactor"></div>
<div id="editor" class="pixedit"></div>
<div id="laboratory"></div>
</body>
</html>
