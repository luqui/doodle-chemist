<html>
<head>
<script src="jquery-3.3.1.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.13.0/firebase.js"></script>
<!-- <script src="https://www.gstatic.com/firebasejs/4.13.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.13.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.13.0/firebase-database.js"></script>
-->
<script src="https://www.gstatic.com/firebasejs/4.13.0/firebase-firestore.js"></script>
<!--
<script src="https://www.gstatic.com/firebasejs/4.13.0/firebase-messaging.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.13.0/firebase-functions.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.13.0/firebase-storage.js"></script>
-->
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyBjpYowQZ1sewFmHEJl9ZDfDx20rsQ_tZQ",
    authDomain: "doodle-chemist.firebaseapp.com",
    databaseURL: "https://doodle-chemist.firebaseio.com",
    projectId: "doodle-chemist",
    storageBucket: "doodle-chemist.appspot.com",
    messagingSenderId: "1086839312639"
  };
  firebase.initializeApp(config);

  // "element1:element2" : {  // element1 <= element2
  //   demand: <nat>
  //   results: {
  //     element3: <nat>
  //     element4: <nat>
  //     ...
  //   }
  var db = firebase.firestore();

  var reactor = function(container) {
    container.empty();
    db.collection("reactions").orderBy("demand", "desc").limit(1).get()
      .then(function(docs) {
        var fail = function() {
          container.append($('<span>').text("Nope"));
          container.append($('<button>').text("Try again").click(function() { reactor(container); }));
        };
        var success = function() {  
          container.append($('<span>').text("Good job"));
          container.append($('<button>').text("Do another").click(function() { reactor(container); }));
        };
        if (docs.empty) { console.log("No reactions"); fail(); return; }

        var doc = docs.docs[0];
        var reagents = doc.id.split(":");
        var proposedBox = $('<input>').attr('type', 'text');
        var okbutton = $('<button>').text('Ok');
        container.append(
          $('<span>').text(reagents[0] + " + " + reagents[1] + " = "),
          proposedBox,
          okbutton);
        
        okbutton.click(function() {
          var proposed = proposedBox.val();
          var docref = db.collection("reactions").doc(doc.id);
          db.runTransaction(function(transaction) {
            return transaction.get(docref)
              .then(function(q) {
                var data = q.data();
                if (!(proposed in data.results)) {
                  data.results[proposed] = 1;
                }
                else {
                  data.results[proposed]++;
                }
                data.demand--;
                transaction.set(docref, data);

                var proposedCount = data.results[proposed];
                if (proposedCount < 3) { return false; }
                for (var i in q.results) {
                  if (q.results[i] >= proposedCount) { return false; }
                }
                return true;
              });
          }).then(function(succeeded) {
            if (succeeded) { success(); } else { fail(); }
          });
        });
      });
  };


  var laboratory = function(container) {
    var elements = ['earth', 'water', 'fire', 'air'];
    
    var populate = function() {
      container.empty();
      
      var box1 = $('<span>');
      var box2 = $('<span>');
      var boxresult = $('<span>');
      container.append(box1, $('<span>').text('+'), box2, $('<span>').text('='), boxresult);
      
      var compute = function() {
        if (box1.text() <= box2.text()) {
          var reaction = box1.text() + ":" + box2.text();
        }
        else {
          var reaction = box2.text() + ":" + box1.text();
        }
        var docref = db.collection("reactions").doc(reaction);
        db.runTransaction(function(transaction) {
          return transaction.get(docref)
            .then(function(q) {
              if (!q.exists) {
                transaction.set(docref, { demand: 1, results: {} });
                return null;
              }
              var data = q.data();
              data.demand++;
              transaction.set(docref, data);

              var best = null;
              var bestscore = 0;
              for (var i in data.results) {
                if (data.results[i] > bestscore) {
                  bestscore = data.results[i];
                  best = i;
                }
              }
              if (bestscore >= 3) {
                return best;
              }
              else {
                return null;
              }
            });
        }).then(function(best) {
          if (best == null) { populate(); return; }
          for (var i = 0; i < elements.length; i++) {
            if (best == elements[i]) { populate(); return; }
          }
          elements.push(best);
          populate();
        });
      };

      var select = function(element) {
        if (box1.text() == "") {
          box1.text(element);
        }
        else if (box2.text() == "") {
          box2.text(element);
          compute();
        }
      };

      for (var i = 0; i < elements.length; i++) {
        (function() { 
          var element = elements[i];
          var button = $('<button>').text(element).click(function() { select(element) });
          container.append(button);
        })();
      }
    }; 

    populate();
  };

  $(function() {
    reactor($('#reactor'));
    laboratory($('#laboratory'));
  });

</script>
</head>
<body>
<div id="reactor"></div>
<div id="laboratory"></div>
</body>
</html>
